# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸŸ¢ NIVEL 1: El Despertar del Pipeline (BÃ¡sico)
# Laboratorio Clase 2 â€” CoinDash
#
# Objetivo: Automatizar el flujo Build â†’ Test â†’ Deploy de la API de Node.js
# DocumentaciÃ³n: https://docs.github.com/es/actions
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: 'Nivel 1 â€” Pipeline CI/CD BÃ¡sico'

on:
  push:
    branches:
      - main
      - 'feature/**'
    paths:
      - 'coindash-api/**'
      - '.github/workflows/nivel-1.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'coindash-api/**'

permissions:
  contents: read

jobs:
  # â”€â”€ Etapa 1: Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: 'ğŸ”¨ Build â€” InstalaciÃ³n de dependencias'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: coindash-api

    steps:
      - name: Checkout del cÃ³digo fuente
        uses: actions/checkout@v4

      - name: Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: coindash-api/package-lock.json

      - name: Instalar dependencias
        run: npm ci

      - name: Guardar node_modules en cachÃ© para etapas siguientes
        uses: actions/cache@v4
        with:
          path: coindash-api/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('coindash-api/package-lock.json') }}

  # â”€â”€ Etapa 2: Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: 'ğŸ§ª Test â€” Pruebas unitarias'
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: coindash-api

    steps:
      - name: Checkout del cÃ³digo fuente
        uses: actions/checkout@v4

      - name: Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: coindash-api/package-lock.json

      - name: Restaurar node_modules desde cachÃ©
        uses: actions/cache@v4
        with:
          path: coindash-api/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('coindash-api/package-lock.json') }}

      - name: Ejecutar pruebas unitarias con cobertura
        run: npm test

      - name: Publicar reporte de cobertura
        uses: actions/upload-artifact@v7
        if: always()
        with:
          name: coverage-report
          path: coindash-api/coverage/

  # â”€â”€ Etapa 3: Deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: 'ğŸš€ Deploy â€” SimulaciÃ³n de despliegue'
    runs-on: ubuntu-latest
    needs: test
    # Solo hacer deploy desde la rama main
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout del cÃ³digo fuente
        uses: actions/checkout@v4

      - name: Simular despliegue a producciÃ³n
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸš€ CoinDash API â€” Desplegando a producciÃ³n  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ VersiÃ³n: $(node -p "require('./coindash-api/package.json').version")"
          echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo ""
          echo "âœ… Despliegue completado exitosamente"
          echo "ğŸŒ URL: https://api.coindash.io (simulado)"

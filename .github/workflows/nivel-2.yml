# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸŸ¡ NIVEL 2: Blindando la Entrega (Intermedio / DevSecOps)
# Laboratorio Clase 2 â€” CoinDash
#
# Objetivo: Implementar "Shift-Left Security" â€” seguridad desde el inicio
# Incluye: SCA (Dependabot), SAST (CodeQL), Secretos (GitHub Secrets),
#          Escaneo de Contenedores (Trivy)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: 'Nivel 2 â€” Pipeline DevSecOps'

on:
  push:
    branches:
      - main
      - 'feature/**'
    paths:
      - 'coindash-api/**'
      - '.github/workflows/nivel-2.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'coindash-api/**'
  schedule:
    # Escaneo de seguridad diario a las 6 AM UTC
    - cron: '0 6 * * *'

permissions:
  contents: read

jobs:
  # â”€â”€ Build + Test (reutilizado del Nivel 1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-test:
    name: 'ğŸ”¨ Build & ğŸ§ª Test'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: coindash-api

    steps:
      - uses: actions/checkout@v4

      - name: Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: coindash-api/package-lock.json

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar pruebas
        run: npm test

  # â”€â”€ SCA: Escaneo de Dependencias â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  dependency-scan:
    name: 'ğŸ” SCA â€” Escaneo de dependencias (npm audit)'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: coindash-api

    steps:
      - uses: actions/checkout@v4

      - name: Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependencias
        run: npm ci

      - name: Auditar vulnerabilidades (falla si hay nivel crÃ­tico)
        run: npm audit --audit-level=critical

      - name: Generar reporte de auditorÃ­a completo
        run: npm audit --json > npm-audit.json || true

      - name: Subir reporte de auditorÃ­a
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report
          path: coindash-api/npm-audit.json

  # â”€â”€ SAST: AnÃ¡lisis EstÃ¡tico con CodeQL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  codeql-analysis:
    name: 'ğŸ›¡ï¸ SAST â€” AnÃ¡lisis estÃ¡tico con CodeQL'
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality

      - name: Realizar anÃ¡lisis CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          category: '/language:javascript'

  # â”€â”€ Escaneo de Contenedores con Trivy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  container-scan:
    name: 'ğŸ³ Escaneo de imagen Docker con Trivy'
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Construir imagen Docker
        run: docker build -t coindash-api:${{ github.sha }} ./coindash-api

      - name: Escanear imagen con Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'coindash-api:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          # â­ BONUS: Falla si se encuentran vulnerabilidades crÃ­ticas
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Subir resultados Trivy a GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # â”€â”€ VerificaciÃ³n de Secretos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  secrets-check:
    name: 'ğŸ”‘ Verificar que no haya secretos expuestos'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Buscar secretos con TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # â”€â”€ Deploy con Secretos de GitHub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  secure-deploy:
    name: 'ğŸš€ Deploy Seguro (usa GitHub Secrets)'
    runs-on: ubuntu-latest
    needs:
      - build-and-test
      - dependency-scan
      - codeql-analysis
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Desplegar con variables de entorno seguras
        env:
          # Estos valores vienen de GitHub Secrets â€” nunca van en el cÃ³digo
          API_SECRET_KEY: ${{ secrets.API_SECRET_KEY }}
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ›¡ï¸  CoinDash API â€” Despliegue Seguro (Nivel 2)  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… SCA: Sin vulnerabilidades crÃ­ticas"
          echo "âœ… SAST: AnÃ¡lisis CodeQL completado"
          echo "âœ… Secretos: Gestionados con GitHub Secrets"
          echo "âœ… Contenedor: Imagen escaneada con Trivy"
          echo ""
          echo "ğŸš€ Desplegando versiÃ³n: ${{ github.sha }}"
          echo "ğŸŒ URL: https://api.coindash.io (simulado)"
          # Verificar que el secreto estÃ¡ disponible sin imprimirlo
          if [ -n "$API_SECRET_KEY" ]; then
            echo "ğŸ”‘ API_SECRET_KEY: âœ… configurada"
          else
            echo "âš ï¸  API_SECRET_KEY: No configurada (agrega el secreto en Settings > Secrets)"
          fi

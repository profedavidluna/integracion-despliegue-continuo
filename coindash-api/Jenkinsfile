/*
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸŸ  NIVEL 3: El Gran Duelo de Orquestadores (Avanzado)
 * Laboratorio Clase 2 â€” CoinDash
 *
 * Objetivo: Implementar el mismo pipeline de CI/CD en Jenkins para comparar
 *           con GitHub Actions (Nivel 1 y 2).
 *
 * Prerrequisitos:
 *   - Jenkins con plugin "Pipeline" instalado
 *   - Docker disponible en el agente Jenkins
 *   - Node.js 20 disponible en el agente (o usar imagen Docker)
 *
 * Cuadro Comparativo (para el debate):
 *   | Criterio            | Jenkins          | GitHub Actions       |
 *   |---------------------|------------------|----------------------|
 *   | Time-to-Setup       | Alto (autohosted)| Bajo (cloud managed) |
 *   | Visibilidad errores | Blue Ocean UI    | UI nativa integrada  |
 *   | Costo startup       | Infra propia     | Gratis (2000 min/mes)|
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

pipeline {
    agent {
        docker {
            image 'node:20-alpine'
            args '-u root'
        }
    }

    environment {
        // Las credenciales se gestionan en Jenkins Credentials Manager
        API_SECRET_KEY = credentials('coindash-api-secret-key')
        NODE_ENV       = 'test'
    }

    options {
        timeout(time: 15, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }

    stages {
        // â”€â”€ Etapa 1: Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Checkout') {
            steps {
                checkout scm
                echo "ğŸŒ¿ Rama: ${env.GIT_BRANCH}"
                echo "ğŸ“ Commit: ${env.GIT_COMMIT}"
            }
        }

        // â”€â”€ Etapa 2: Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Build') {
            steps {
                dir('coindash-api') {
                    echo 'ğŸ”¨ Instalando dependencias...'
                    sh 'npm ci'
                    echo 'âœ… Dependencias instaladas'
                }
            }
        }

        // â”€â”€ Etapa 3: Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Test') {
            steps {
                dir('coindash-api') {
                    echo 'ğŸ§ª Ejecutando pruebas unitarias...'
                    sh 'npm test'
                }
            }
            post {
                always {
                    // Publicar reporte de cobertura en Jenkins
                    publishHTML(target: [
                        allowMissing         : false,
                        alwaysLinkToLastBuild: true,
                        keepAll              : true,
                        reportDir            : 'coindash-api/coverage/lcov-report',
                        reportFiles          : 'index.html',
                        reportName           : 'Coverage Report'
                    ])
                }
            }
        }

        // â”€â”€ Etapa 4: Security Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Security Scan') {
            steps {
                dir('coindash-api') {
                    echo 'ğŸ” Auditando dependencias...'
                    sh 'npm audit --audit-level=critical || true'
                }
            }
        }

        // â”€â”€ Etapa 5: Docker Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Docker Build') {
            when {
                branch 'main'
            }
            agent {
                label 'docker'
            }
            steps {
                echo 'ğŸ³ Construyendo imagen Docker...'
                sh "docker build -t coindash-api:${env.GIT_COMMIT} ./coindash-api"
                echo 'âœ… Imagen construida exitosamente'
            }
        }

        // â”€â”€ Etapa 6: Deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                echo 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'
                echo 'â•‘  ğŸš€ CoinDash API â€” Deploy (Jenkins)    â•‘'
                echo 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo "ğŸ“¦ VersiÃ³n: ${env.GIT_COMMIT}"
                echo 'âœ… Despliegue simulado completado'
                echo 'ğŸŒ URL: https://api.coindash.io (simulado)'
            }
        }
    }

    post {
        success {
            echo 'âœ… Pipeline completado exitosamente'
        }
        failure {
            echo 'âŒ Pipeline fallÃ³ â€” revisa los logs arriba'
            // â­ BONUS: NotificaciÃ³n de Slack cuando falla el pipeline
            // slackSend(
            //   channel: '#coindash-deploys',
            //   color: 'danger',
            //   message: "âŒ Pipeline fallÃ³ en ${env.JOB_NAME} #${env.BUILD_NUMBER}\n${env.BUILD_URL}"
            // )
        }
        always {
            cleanWs()
        }
    }
}
